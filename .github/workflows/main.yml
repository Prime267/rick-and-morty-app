# This is the main CI/CD pipeline for the SRE Home Assignment
# It follows SRE best practices:
# 1. Gating: The 'build-push' job only runs if 'lint-test' succeeds.
# 2. Separation: Uses dev dependencies for testing, runtime for the image.
# 3. Automation: Lints, tests, builds, and pushes the image automatically.

name: SRE App CI/CD Pipeline

on:
  # Run on pushes to the main branch
  push:
    branches:
      - main
      - master
  # Also run on Pull Requests targeting the main branch
  pull_request:
    branches:
      - main
      - master

jobs:
  # --- JOB 1: LINT & TEST ---
  lint-test:
    name: Lint & Test
    runs-on: ubuntu-latest

    steps:
      - name: 1. Check out repository code
        uses: actions/checkout@v4

      - name: 2. Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: 3. Install all dependencies
        run: pip install -r requirements-dev.txt

      - name: 4. Run Linter (Ruff)
        run: ruff check app/ tests/

      - name: 5. Run Unit Tests
        run: python -m pytest -m unit

      - name: 6. Run Integration Tests
        run: python -m pytest -m integration

  # --- JOB 2: BUILD & PUSH DOCKER IMAGE ---
  build-push:
    name: Build & Push Image
    runs-on: ubuntu-latest
    
    # Reference the PROD environment for secrets
    environment: PROD 

    needs: lint-test
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')

    steps:
      - name: 1. Check out repository code
        uses: actions/checkout@v4

      - name: 2. Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: 3. Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: 4. Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USER }}
          password: ${{ secrets.DOCKERHUB_TOKEN }} # Use the Access Token here

      - name: 5. Build and push image
        uses: docker/build-push-action@v6
        with:
          context: . 
          file: ./Dockerfile 
          push: true 
          tags: |
            ${{ secrets.DOCKERHUB_USER }}/rick-morty-app:latest
            ${{ secrets.DOCKERHUB_USER }}/rick-morty-app:${{ github.sha }}
          platforms: linux/amd64 
